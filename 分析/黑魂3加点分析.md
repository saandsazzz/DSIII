# 黑魂3加点模拟

## 分析各能力值对属性的影响

选择一无所有者开局，该出身初始能力值均为10，方便对比分析。

通过分别对单个能力值加点20、40、80，分析各能力值对属性的影响。



首先基本能力大多只受到单个能力值影响，其他能力值的增减不会引起其变化。

| 能力值 | 基本能力         | 增长规律                                                     |
| ------ | ---------------- | ------------------------------------------------------------ |
| 生命力 | 血量             | 随着生命力提升，血量增加速度逐渐降低                         |
| 集中力 | 专注值、记忆空格 | 随着集中力提升，专注值增加速度逐渐降低，记忆空格增加速度也是逐渐降低 |
| 持久力 | 精力             | 随着持久力提升，精力增加速度逐渐降低                         |
| 体力   | 装备重量         | 随着体力增长，装备重量线性增加                               |
| 运气   | 寻宝能力         | 随着运气增长，寻宝能力线性增加                               |

然后是防御力，按照加点影响可以分为两类，防御力1：物理、防打击、防斩击、防突刺；防御力2：魔力、火、雷、暗。

防御力1除了体力和力气有额外增加外，其他能力值对其影响均一致，那么计算公式可以写为：

$$
系数1*总能力值+系数2*体力值+系数3*力气值
$$

防御力2每一项均有一个对应的能力值对其影响较大，其他能力值影响均一致，且与防御力1中的影响也一致，计算公式可以写为：

$$
系数1*总能力值+系数4*对应能力值
$$

| 防御力 | 能力值 |
| ------ | ------ |
| 魔力   | 智力   |
| 火     | 力气   |
| 雷     | 持久力 |
| 暗     | 信仰   |

最后是抵抗力，与防御力2基本类似，不过对应能力值的影响只有在该能力值超过30之后才会出现，计算公式也与防御力2类似：

$$
系数5*总能力值+系数6*对应能力值
$$

| 抵抗力 | 能力值 |
| ------ | ------ |
| 出血   | 持久力 |
| 毒     | 体力   |
| 寒气   | 生命力 |
| 咒死   | 运气   |

**各系数并非为常数，而是一个与其所乘值相关的函数。**

最后选择将各属性写做能力值的一个通式，能力值为x<sub>i</sub>，属性为y<sub>i</sub>：

$$
y_j=\sum_1^9f_{ij}(x_i)
$$

<h3 align = "center">防御力与抵抗力计算函数表</h3>

| <span style="display:inline-block;width:100px"> </span> | <span style="display:inline-block;width:100px">物理(y<sub>1</sub>)</span> | <span style="display:inline-block;width:100px">防打击(y<sub>2</sub>)</span> | <span style="display:inline-block;width:100px">防斩击(y<sub>3</sub>)</span> | <span style="display:inline-block;width:100px">防突刺(y<sub>4</sub>)</span> | <span style="display:inline-block;width:100px">魔力(y<sub>5</sub>)</span> | <span style="display:inline-block;width:100px">火(y<sub>6</sub>)</span> | <span style="display:inline-block;width:100px">雷(y<sub>7</sub>)</span> | <span style="display:inline-block;width:100px">暗(y<sub>8</sub>)</span> | <span style="display:inline-block;width:100px">出血(y<sub>9</sub>)</span> | <span style="display:inline-block;width:100px">毒(y<sub>10</sub>)</span> | <span style="display:inline-block;width:100px">寒气(y<sub>11</sub>)</span> | <span style="display:inline-block;width:100px">咒死(y<sub>12</sub>)</span> |
| ------------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 生命力（x<sub>1</sub>）                                 | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | function6                                                    | 0                                                            |
| 集中力（x<sub>2</sub>）                                 | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            |
| 持久力（x<sub>3</sub>）                                 | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | function5                                                    | 0                                                            | function6                                                    | 0                                                            | 0                                                            | 0                                                            |
| 体力（x<sub>4</sub>）                                   | function3                                                    | function3                                                    | function3                                                    | function3                                                    | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | function6                                                    | 0                                                            | 0                                                            |
| 力气（x<sub>5</sub>）                                   | function4                                                    | function4                                                    | function4                                                    | function4                                                    | 0                                                            | function5                                                    | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            |
| 敏捷（x<sub>6</sub>）                                   | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            |
| 智力（x<sub>7</sub>）                                   | 0                                                            | 0                                                            | 0                                                            | 0                                                            | function5                                                    | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            |
| 信仰（x<sub>8</sub>）                                   | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | function5                                                    | 0                                                            | 0                                                            | 0                                                            | 0                                                            |
| 运气（x<sub>9</sub>）                                   | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | 0                                                            | function6                                                    |
| 总和（x<sub>10</sub>）                                  | function1                                                    | function1                                                    | function1                                                    | function1                                                    | function1                                                    | function1                                                    | function1                                                    | function1                                                    | function2                                                    | function2                                                    | function2                                                    | function2                                                    |

各函数的参数为其所对应行的x<sub>i</sub>。

接下来就通过对各能力值逐步加点分析各函数的具体公式。

## 具体公式推导

各属性显示值基本为整数，但计算时必然是会出现小数，考虑到基本上编程语言的自带类型转换到整型都是退一法，暂定为退一法进行分析，出现矛盾再更换。

### 抵抗力

如[表](#防御力与抵抗力计算函数表)所示，影响抵抗力的两个函数function2和function6很容易分离考虑计算，各能力值小于30时function6为0，并且有5个能力值到99都不会出现function6。

所以首先对抵抗力计算公式进行推算分析

（1）function2

分离function6之后，可以得到90~1095的函数值，如图所示

![Alt text](https://github.com/saandsazzz/DSIII/blob/main/image/Figure_1.png)

显然是一个分段函数，并且由四个直线段组成，但是由于存在取整操作，直线斜率与方程较难直接得出，不过观察到在150~190段，斜率基本确定为1，考虑正常确定函数时这种地方不太会出现奇奇怪怪的小数值，直接假定这一段函数为

$$
function2(x)=x-30\quad 150\leq x<190
$$

第三段函数190~240也很规整，前端点后端点都重合并且斜率为0.3很整齐，这一段函数也可以写出

$$
function2(x)=0.3x+103\quad 190\leq x<240
$$

顺着以规整斜率的思路整理下去，第一段应设为0.2，第四段应设为1/26，但是都会出现一个问题，**端点值不吻合**。

那么假设端点值就是不吻合的，又会发现第一段中后端点值需要归于第二段，而第四段中前端点值需要归于第三段，分段函数范围规定就会出现	x<150,x<190,x<=240,else	**这种不符合常理的分段，因此这两段暂定。**

（2）function6

所有能力值的变化都会引起function2的值变化，所以分离function6需要完全确定function2才行，150~190这一段再适合不过了，完全的整数可以轻松减去，完全不用考虑小数部分的计算。

![Alt text](https://github.com/saandsazzz/DSIII/blob/main/image/Figure_2.png)

也是非常工整的分段直线函数，前3段斜率工整，端点吻合，很容易都可以确定下来

$$
function6(x)=
\begin{cases} 
0,\quad \quad \quad \quad \quad x<30 \\
3x-90\quad \quad \quad 30\leq x<40 \\
0.5x+10\quad \quad \quad 40\leq x<60 \\
\end{cases}
$$

第四段直观来看斜率为0.25，但是这样算会在最后一个99处出现问题，还是**端点处不吻合**，结合前面function2中第一段和第四段函数的问题，发现不去考虑规整斜率，考虑**规整点相连接**可以完美的避开这些问题。

这里function6前三段都是规整点连接，第四段以规整点（60，40）与（99，50）连接，所有取整值均满足

（3）调整function2

中间两端都是规整点相连，无需调整，第四段以规整点（240，175）与（891，200）连接，第一段以（1，90）与（150，120）连接。

至此两个函数都完全确定，并且在两个函数中分别选取一些**小数部分相加为0.9~1.1的取值**来进行验算，都完全符合。

|      | function2    | function6  |
| ---- | ------------ | ---------- |
| 点1  | （1，90）    | （0，0）   |
| 点2  | （150，120） | （30，0）  |
| 点3  | （190，160） | （40，30） |
| 点4  | （240，175） | （60，40） |
| 点5  | （891，200） | （99，50） |

由两点式直线函数确定所有分段函数。

通过这里的分析，不仅得到了function2与function6的通式，更重要的可以了解到设计者对分段函数取值的设计思路，是由规整点来确定函数的一些系数，而不是使用规整的函数系数。

### 防御力

如[表](#防御力与抵抗力计算函数表)所示，需要计算function1、function3、function4、function5。

要分离各函数的话，首先考虑分离function1，但是由于力量与体力有初始值，导致function3，function4可能会有部分小数值加在了里面，那么用分离function2的方法来分离的话，由于34可能包含的小数部分，导致y与x关系不明显，或者说确切点的位置不好确定。

所以这里考虑先去找function3与function4的函数，然后将力量体力设置为令值为整数，再来确定function1。

（1）function3

这里首先将总点数设置到一个比较大的位置，处于function1的最后一段斜率很小的直线段（虽然没有确定function1，但是可以看出其也是大约为一个四段直线函数），值刚好增加1的位置，这个时候值离其所显示的整数值相差无几。

然后逐步增加体力值，同时减少其他点数，**保持总点数不变**，用物理防御值减去属性防御力中未被影响的值便可以得到function3的值，准确来说是fuction3的值加function4（10）减去function5（10），**比实际的function3略小**（通过全10点时数据可以得到function3（10）+function4（10）大致等于function5（10））。

那么基本就可以确定几个固定点（略小）

**（15，2），（25，19），（40，37），（99，57）**

第一个点这时不好确定，等到后面确定function1后再来确定

（2）function4

同（1）中方法，确定固定点（略小）为

**（30，7），（40，12），（60，27），（99，37）**

（3）function1

固定体力为15，力量为30，现在可以发现function1可以轻松的找到整齐的固定点

**（150，106），（170，116），（240，126）**

这里其实各函数同时平移对应值的话并不会影响最终的结果，这里为了使y值整齐，可以整体平移一下

并且3函数结合起来可以确定第一个固定点。

| function1 | x    | y    | function3 | x    | y    | function4 | x    | y    |
| --------- | ---- | ---- | --------- | ---- | ---- | --------- | ---- | ---- |
| 点1       | 1    | 40   | 点1       | 0    | 0    | 点1       | 0    | 0    |
| 点2       | 150  | 100  | 点2       | 15   | 5    | 点2       | 30   | 10   |
| 点3       | 170  | 110  | 点3       | 25   | 22   | 点3       | 40   | 15   |
| 点4       | 240  | 120  | 点4       | 40   | 40   | 点4       | 60   | 30   |
| 点5       | 891  | 150  | 点5       | 99   | 60   | 点5       | 99   | 40   |

（4）function5

固定总和在240，逐步增加function5有关的一个能力值，即可得到x，y对应表

确定固定点为

| function5 | x    | y    |
| --------- | ---- | ---- |
| 点1       | 0    | 0    |
| 点2       | 30   | 20   |
| 点3       | 40   | 40   |
| 点4       | 60   | 70   |
| 点5       | 99   | 100  |

### 血量、专注值、精力

血量、专注值和精力的变化比较复杂，不再是前面的分段直线，部分段为曲线。

血量曲线：

![Alt text](https://github.com/saandsazzz/DSIII/blob/main/image/HP_curve.png)

专注值曲线：

![Alt text](https://github.com/saandsazzz/DSIII/blob/main/image/FP_curve.png)

精力曲线：

![Alt text](https://github.com/saandsazzz/DSIII/blob/main/image/Stamina_curve.png)

曲线应当都是对几个固定点进行插值补充，类似与Hermit插值的方法进行补充，而且插值的方法能够保证函数在插值段是单增函数

由于小数取整等影响，而且部分点的数据变化难以用多项式函数来拟合

尝试了像样条插值方法、PCHIP插值方法等多种插值方法都没有反推出符合所有值的通式。

由于数据数量有限并且都是单一影响，这里直接99个对应的值存入了计算器中

### 装备重量

明显线性关系

### 寻宝能力

明显线性关系

### 记忆空格

随着集中力的增加呈现阶梯式增长，一共只有十个，没有必要设计成函数公式然后取整，因此这里直接看作阶梯式函数

### 升级需要魂量

首先大概列出了前100多级的数据，前后作差后很容易发现前10级的差呈线性，后面再次做差后呈线性，基本可以确定前10级是个二次函数，10级以后现猜测为三次函数，拟合后直接取802级的预测值与实际结果对比，发现基本一致。

所以直接按照三次函数来进行拟合，为了让拟合的结果取整后尽量与实际一致，先将记录的样点值都**+0.5**，再进行最小二乘法拟合。

为了综合考虑整个802级的数据，拟合用的样本点选择了11-130级和700-802级的数据。

三次函数拟合后发现在700以后仍然有不少点取整后与实际不符，但是130之前取整后都完全符合实际。

综合考虑后选择使用**四次函数**进行拟合，拟合出的四次项系数非常小，但是有效的调节了700以后的值，几乎满足了样本中所有的点取整后与实际相符。

最终得到的函数为

$$
Souls(level)=\begin{cases} 0.12*level^2+16*level+657.4,\quad \quad \quad \quad \quad \quad \quad \quad \quad \quad \quad \quad \quad \quad \quad \quad \quad \quad\quad  level\leq 10 \\-1e^{-12}*level^4 + 0.02*level^3 + 3.12*level^2 + 111.78*level - 786.2, \quad \quad \quad level>10 \\\end{cases}
$$

